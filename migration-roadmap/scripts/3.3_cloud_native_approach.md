## REPLATFORM Strategy: Cloud-Native Architecture

### Candidates for REPLATFORM (9 applications)
1. **POS003** - Point of Sale Transaction
2. **MEMBER006** - Membership Management
3. **SHIP004** - Shipping Logistics
4. **TAX012** - Sales Tax Calculation
5. **LOYALTY021** - Rewards Program Engine
6. **RETURNS016** - Return Authorization
7. **AUDIT022** - Compliance Audit Trail
8. **RPT011** - Executive Dashboard Batch
9. **EDI024** - Electronic Data Interchange

**Common Characteristics:**
- Moderate technical debt (TDI 12-22)
- Well-defined business logic (can be preserved)
- Database-centric (limited RPG/COBOL compute logic)
- Suitable for Cloud SQL + BigQuery hybrid

---

### Target Architecture Pattern
```
┌────────────────────────────────────────────────────────────────┐
│ REPLATFORM Architecture (POS003 Example)                       │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐         ┌──────────────┐                    │
│  │ POS Terminal │────────>│  API Gateway │                    │
│  │ (legacy)     │  HTTPS  │  (Cloud Armor)│                   │
│  └──────────────┘         └───────┬──────┘                    │
│                                    │                            │
│                          ┌─────────▼────────────┐              │
│                          │   Cloud Run Service  │              │
│                          │  (POS Transaction)   │              │
│                          │  - Java Spring Boot  │              │
│                          │  - Stateless         │              │
│                          └──────────┬───────────┘              │
│                                     │                           │
│              ┌──────────────────────┼──────────────┐           │
│              │                      │              │           │
│      ┌───────▼──────┐      ┌───────▼──────┐  ┌───▼────┐      │
│      │  Cloud SQL   │      │   Pub/Sub    │  │  BQ    │      │
│      │ (PostgreSQL) │      │   (events)   │  │(analytics)│   │
│      │              │      │              │  │        │      │
│      │ - POSSALE    │      │ Topic:       │  │ Streaming│    │
│      │ - POSITEM    │      │ sale-complete│  │ Insert   │    │
│      │ - POSTENDR   │      └───────┬──────┘  └────────┘      │
│      └──────────────┘              │                           │
│                                     │                           │
│                    ┌────────────────┼────────────────┐         │
│                    │                │                │         │
│            ┌───────▼──────┐  ┌─────▼──────┐  ┌─────▼──────┐  │
│            │  Cloud Run   │  │ Cloud Run  │  │ Cloud Run  │  │
│            │  (Inventory) │  │ (Loyalty)  │  │  (Audit)   │  │
│            └──────────────┘  └────────────┘  └────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

**Key Design Principles:**
1. **Microservices**: Each AS400 app becomes 1-3 Cloud Run services
2. **Event-Driven**: Pub/Sub replaces IBM MQ (async decoupling)
3. **Polyglot**: Use best language per service (Java for transactional, Python for batch)
4. **API-First**: All services expose REST/gRPC APIs
5. **Observability**: Cloud Logging, Monitoring, Trace built-in

---

### Data Migration Path: Bulk + CDC

**Phase 1: Bulk Load (offline)**
```bash
# Export from DB2/400 to CSV
CPYTOIMPF FROMFILE(COSTCOPRD/POSSALE) +
          TOFILE('/export/possale.csv') +
          MBROPT(*REPLACE) RCDDLM(*CRLF) DTFMT(*ISO)

# Transfer to GCS
gsutil -m cp -r /export/*.csv gs://costco-migration-bulk/possale/

# Load to Cloud SQL (PostgreSQL)
gcloud sql import csv costco-prod-db \
  gs://costco-migration-bulk/possale/*.csv \
  --database=costco_prod \
  --table=possale \
  --columns=sale_id,warehouse_id,register_num,sale_date,...
```

**Phase 2: CDC Cutover (online)**
```
┌─────────────────────────────────────────────────────────────┐
│ Datastream for CDC (Change Data Capture)                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  AS400 DB2/400         Datastream          Cloud SQL        │
│  ┌────────────┐       ┌──────────┐       ┌──────────┐      │
│  │  POSSALE   │──────>│  Stream  │──────>│ possale  │      │
│  │  (source)  │ DRDA  │  Profile │  VPN  │ (target) │      │
│  └────────────┘       └──────────┘       └──────────┘      │
│                             │                                │
│                             └────> Pub/Sub (change events)  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Cutover Steps:**
1. Start Datastream profile (T-48 hours before cutover)
2. Validate replication lag < 5 seconds
3. Enable dual-write in AS400 apps (write to both AS400 + Cloud SQL)
4. Cutover window: Pause AS400 writes for 15 minutes
5. Verify Cloud SQL is caught up (replication lag = 0)
6. Switch API traffic to Cloud Run services
7. Monitor for 1 hour, rollback if issues

---

### API Design Pattern: REST with OpenAPI

**Example: Tax Calculation Service (TAX012)**
```yaml
openapi: 3.0.3
info:
  title: Tax Calculation API
  version: 2.0.0
  description: Real-time sales tax calculation with jurisdiction breakdown

paths:
  /api/v2/tax/calculate:
    post:
      summary: Calculate sales tax for a transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      item_sku:
                        type: string
                      quantity:
                        type: integer
                      unit_price:
                        type: number
                ship_to:
                  type: object
                  properties:
                    zip_code:
                      type: string
                    state:
                      type: string
      responses:
        '200':
          description: Tax calculation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  subtotal:
                    type: number
                  tax_details:
                    type: array
                    items:
                      type: object
                      properties:
                        jurisdiction:
                          type: string
                        tax_type:
                          type: string
                        tax_rate:
                          type: number
                        tax_amount:
                          type: number
                  total_tax:
                    type: number
```

**Implementation (Java Spring Boot on Cloud Run):**
```java
@RestController
@RequestMapping("/api/v2/tax")
public class TaxCalculationController {
    
    @Autowired
    private TaxRateRepository taxRateRepo;  // Cloud SQL
    
    @Autowired
    private TaxJarClient taxJarClient;  // External API fallback
    
    @PostMapping("/calculate")
    public TaxCalculationResponse calculate(@RequestBody TaxCalculationRequest request) {
        
        // Lookup tax jurisdiction by ZIP
        TaxJurisdiction jurisdiction = taxRateRepo.findByZipCode(request.getShipTo().getZipCode());
        
        List<TaxDetail> taxDetails = new ArrayList<>();
        BigDecimal totalTax = BigDecimal.ZERO;
        
        for (Item item : request.getItems()) {
            // Get tax rates for category
            List<TaxRate> rates = taxRateRepo.findByJurisdictionAndCategory(
                jurisdiction.getId(), 
                item.getTaxCategory()
            );
            
            BigDecimal itemTotal = item.getUnitPrice().multiply(new BigDecimal(item.getQuantity()));
            
            for (TaxRate rate : rates) {
                BigDecimal taxAmount = itemTotal.multiply(rate.getRate());
                totalTax = totalTax.add(taxAmount);
                
                taxDetails.add(new TaxDetail(
                    rate.getJurisdictionName(),
                    rate.getTaxType(),
                    rate.getRate(),
                    taxAmount
                ));
            }
        }
        
        return new TaxCalculationResponse(
            request.getSubtotal(),
            taxDetails,
            totalTax
        );
    }
}
```

---

### Backward Compatibility During Transition

**Challenge:** AS400 clients expect program calls (CALL PGM), not REST APIs

**Solution: Adapter Pattern**
```
AS400 Client (RPG)                  GCP Cloud Run
┌───────────────┐                   ┌──────────────────┐
│ CALL TAX012/  │                   │  Tax Calculation │
│ TAXCALC       │                   │  REST API        │
│ PARM(ITEMS    │                   │  (new)           │
│      ZIP      │                   └────────▲─────────┘
│      *RETURN) │                            │
└───────┬───────┘                            │
        │                                    │
        │  ┌─────────────────────────────────┤
        └─>│  AS400 Adapter (CL wrapper)    │
           │  - Receives CALL PGM            │
           │  - Converts to HTTP POST        │
           │  - Returns to caller            │
           └─────────────────────────────────┘

CL Adapter Code:
PGM PARM(&ITEMS &ZIP &RETURN)
    DCL VAR(&ITEMS) TYPE(*CHAR) LEN(5000)
    DCL VAR(&ZIP) TYPE(*CHAR) LEN(10)
    DCL VAR(&RETURN) TYPE(*CHAR) LEN(2000)
    DCL VAR(&JSON) TYPE(*CHAR) LEN(8000)
    
    /* Build JSON request */
    CHGVAR VAR(&JSON) VALUE('{"items":' *CAT &ITEMS *CAT ',"ship_to":{"zip_code":"' *CAT &ZIP *CAT '"}}')
    
    /* Call Cloud Run API */
    STRPCCMD PCCMD('curl -X POST https://tax-api.run.app/calculate -d ''' *CAT &JSON *CAT '''') +
             PAUSE(*NO) OUTPUT(*CAPTURE) OUTPUTFILE(&RETURN)
ENDPGM
```

**Benefit:** Zero-downtime cutover - AS400 clients work unchanged while backend moves to GCP